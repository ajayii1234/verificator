<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verificator — Prototype</title>
<style>
  :root{
    --bg: #f5f7fb;
    --card: #ffffff;
    --primary: #0B7AFF;
    --primary-600: #095fdc;
    --success: #28A745;
    --danger: #E04B4B;
    --muted: #6c6c6c;
    --text: #111827;
    --radius-lg: 14px;
    --radius: 10px;
    --gap: 12px;
    --shadow: 0 8px 30px rgba(15,23,42,0.06);
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
  .app{max-width:420px;margin:18px auto;padding-bottom:40px;}
  .frame{
    width:360px;
    height: min(780px, calc(100vh - 36px));
    max-height: calc(100vh - 36px);
    background:transparent;
    margin:0 auto;border-radius:18px;box-shadow:var(--shadow);overflow:hidden;
    position:relative;background:linear-gradient(180deg,#f9fbff,#f5f7fb);
    box-sizing:border-box;
    display:flex;
  }
  .screen{position:absolute;inset:0;padding:20px;display:flex;flex-direction:column;gap:12px;transform:translateX(100%);opacity:0;transition:all 300ms cubic-bezier(.2,.9,.3,1);will-change:transform,opacity;background:transparent;min-height:0;}
  .screen.active{transform:translateX(0);opacity:1;}
  .header{display:flex;align-items:center;justify-content:space-between;}
  h1{margin:0;font-size:24px;letter-spacing:-0.3px;}
  .sub{color:var(--muted);font-size:13px;}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(12,14,20,0.03);}
  .card-scroll{flex:1;display:flex;flex-direction:column;overflow:auto;padding:12px;gap:12px;min-height:0;}
  .login-center{display:flex;flex-direction:column;justify-content:center;align-items:stretch;gap:14px;padding:18px;}
  .input{width:100%;height:48px;border-radius:10px;padding:10px 12px;border:1px solid rgba(16,24,40,0.06);background:#fff;font-size:16px;box-sizing:border-box;}
  .btn{height:48px;border-radius:10px;border:0;padding:0 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 14px rgba(11,122,255,0.08);}
  .btn-primary{background:var(--primary);color:#fff;}
  .btn-primary:active{background:var(--primary-600);}
  .btn-ghost{background:transparent;border:1px solid rgba(11,122,255,0.12);color:var(--primary);box-shadow:none;height:44px;}
  .row{display:flex;gap:10px;}
  .store-list{flex:1;overflow:auto;padding-right:6px;}
  .store-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 1px 8px rgba(12,14,20,0.03);cursor:pointer;}
  .thumb{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#eee,#ddd);display:flex;align-items:center;justify-content:center;font-weight:700;color:#888;}
  .store-info{flex:1;}
  .chev{width:20px;opacity:0.6;font-size:22px;line-height:1;}
  .footer-actions{display:flex;gap:10px;margin-top:8px;}
  .btn-success{background:var(--success);color:white;}
  .btn-danger{background:var(--danger);color:white;}
  .meta{font-size:13px;color:var(--muted);margin-top:4px;}
  .questions{display:flex;flex-direction:column;gap:12px;margin-top:8px;}
  .q{background:#fff;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 4px rgba(12,14,20,0.03);}
  .yesno{display:flex;gap:8px;}
  .chip{padding:8px 12px;border-radius:8px;border:1px solid rgba(12,14,20,0.06);min-width:64px;text-align:center;cursor:pointer;user-select:none;font-weight:700;}
  .chip.active.yes{background:rgba(40,167,69,0.12);border-color:rgba(40,167,69,0.18);color:var(--success);}
  .chip.active.no{background:rgba(224,75,75,0.12);border-color:rgba(224,75,75,0.16);color:var(--danger);}
  .chip.active { border-color: rgba(11,122,255,0.18); color: var(--primary); background: rgba(11,122,255,0.06); }
  .small{font-size:13px;color:var(--muted);}
  .title-big{font-size:18px;font-weight:800;margin-bottom:6px;}
  .upload-area{background:#fff;padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;border:2px dashed rgba(11,122,255,0.08);min-height:120px;}
  input[type=file]{display:none;}
  .img-preview{width:100%;max-width:320px;height:160px;border-radius:8px;object-fit:cover;background:#f2f2f2;border:1px solid rgba(12,14,20,0.04);}
  .top-meta{font-size:12px;color:var(--muted);}
  .home-cta{margin-top:auto;text-align:center;}
  .note{font-size:12px;color:var(--muted);}
  .back-link{color:var(--muted);cursor:pointer;font-size:14px;}
  .map-pin{width:20px;height:20px;border-radius:20px;background:radial-gradient(circle at 40% 30%,#0b7aff, #0a62d6);display:inline-block;margin-left:6px;vertical-align:middle;}
  .login-card{margin-top:28px;border-radius:14px;padding:18px;display:flex;flex-direction:column;gap:12px;box-shadow:0 10px 30px rgba(11,122,255,0.06);background:linear-gradient(180deg,#ffffff,#f7fbff);}
  .brand{font-weight:800;font-size:26px;color:var(--primary);}
  .credentials {display:flex;gap:8px;flex-direction:column;}
  .quick-logins{display:flex;gap:8px;flex-wrap:wrap;}
  .badge{padding:6px 10px;border-radius:8px;background:rgba(11,122,255,0.06);color:var(--primary);font-weight:700;font-size:13px;}
  .muted-block{font-size:13px;color:var(--muted);}
  .hidden{display:none!important;}

  /* status badge for store list */
  .status-badge{padding:6px 10px;border-radius:8px;background:rgba(11,122,255,0.06);color:var(--primary);font-weight:700;font-size:13px;white-space:nowrap;}
  .status-badge.completed{background:rgba(40,167,69,0.12);color:var(--success);}

  @media (min-width: 900px) {
    .app { max-width: 920px; margin: 28px auto; padding-bottom: 48px; }
    .frame {
      width: 720px;
      height: min(960px, calc(100vh - 56px));
      max-height: calc(100vh - 56px);
    }
    .screen { padding: 28px; }
    .card { padding: 16px; border-radius: 14px; }
    .card-scroll { padding: 16px; }
    .input, .btn { height: 52px; border-radius: 12px; font-size: 16px; }
    .btn-ghost { height: 48px; }
    .thumb { width: 72px; height: 72px; border-radius: 12px; }
    .store-item { padding: 14px; gap: 16px; border-radius: 12px; }
    .img-preview { height: 220px; max-width: 640px; border-radius: 10px; }
    .title-big { font-size: 20px; }
    .brand { font-size: 30px; }
    .questions .q { padding: 14px; }
    .chip { min-width: 72px; padding: 10px 14px; }
  }
  @media (min-width: 1280px) { .frame { width: 840px; height: min(1040px, calc(100vh - 64px)); max-height: calc(100vh - 64px); } .screen { padding: 32px; gap: 16px; } }
  @media (max-width: 360px) { .frame { width: 320px; height: min(700px, calc(100vh - 24px)); max-height: calc(100vh - 24px); } .app { max-width: 360px; margin: 12px auto; } }
</style>
</head>
<body>
<div class="app">
  <div class="frame" id="appFrame">
    <!-- Login -->
    <section id="screen-login" class="screen active">
      <div class="header"><div><div class="brand">Verificator</div><div class="sub">Mobile verification app prototype</div></div><div class="top-meta">v1.0</div></div>

      <div class="login-card">
        <div class="muted-block">Demo accounts</div>
        <div class="quick-logins">
          <button class="btn btn-ghost" onclick="fillDemo('phone')">Phone verifier — <span class="badge">phone_user</span></button>
          <button class="btn btn-ghost" onclick="fillDemo('field')">Field verifier — <span class="badge">field_user</span></button>
        </div>

        <div class="login-center">
          <div><label class="small">Username</label><input id="username" class="input" placeholder="Enter username (or use demo buttons)"></div>
          <div><label class="small">Password</label><input id="password" type="password" class="input" placeholder="Enter password"></div>
          <div style="display:flex;gap:8px;">
            <button id="btnLogin" class="btn btn-primary">Sign in</button>
            <button class="btn btn-ghost" onclick="clearForm()">Clear</button>
          </div>
          <div class="muted-block">Demo credentials: <strong>phone_user / phone123</strong> or <strong>field_user / field123</strong>. If username contains 'phone' or 'field' it will auto-select the mode.</div>
        </div>
      </div>

      <div style="padding:6px 2px;"><div class="small">Tip: demo users go straight to the proper flow.</div></div>
    </section>

    <!-- Selector if ambiguous -->
    <section id="screen-select" class="screen">
      <div class="header"><h1>Choose verifier</h1><div class="top-meta">Pick your verification mode</div></div>
      <div class="card" style="margin-top:12px;">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <button class="btn btn-primary" onclick="startMode('phone')">Phone Verif.</button>
          <button class="btn btn-ghost" onclick="startMode('field')">Field Verif.</button>
        </div>
      </div>
      <div class="note" style="margin-top:auto;">(Tip: include "phone" or "field" in username to auto-select.)</div>
    </section>

    <!-- Phone List -->
    <section id="screen-phone-list" class="screen">
      <div class="header"><h1>Phone Verif.</h1><div class="top-meta" id="phone-meta"></div></div>
      <div class="store-list card" id="phoneList"></div>
      <div class="footer-actions"><button class="btn btn-ghost" onclick="logout()">Logout</button></div>
    </section>

    <!-- Phone Detail -->
    <section id="screen-phone-detail" class="screen">
      <div class="header"><h1>Phone Verif.</h1><div class="top-meta" id="phone-detail-meta"></div></div>
      <div class="card">
        <div class="title-big" id="phone-detail-title">Handling Obj.</div>
        <div class="small" id="phone-detail-body">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</div>
        <div class="meta" id="phone-detail-sub">Phone Number: 0803 123 — PIC name: Mr. Ketut</div>
      </div>
      <div class="row" style="margin-top:auto;">
        <button class="btn btn-success" id="btnPhoneStart">Start</button>
        <button class="btn btn-danger" onclick="navigateBack()">Cancel</button>
      </div>
    </section>

    <!-- Phone Questions -->
    <section id="screen-phone-questions" class="screen">
      <div class="header"><h1>Phone Verif.</h1><div class="top-meta" id="phone-questions-meta">verif on xx date by xx</div></div>
      <div class="card-scroll" id="phoneQuestionsCard">
        <div class="questions" id="phoneQuestions"></div>
        <div style="margin-top:8px;display:flex;gap:10px;">
          <button class="btn btn-primary" id="phoneSubmit">Submit</button>
          <button class="btn btn-ghost" onclick="navigateBack()">Back</button>
        </div>
      </div>
    </section>

    <!-- Phone Success -->
    <section id="screen-phone-success" class="screen">
      <div class="header"><h1>Phone Verif.</h1><div class="top-meta"></div></div>
      <div class="card" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="title-big">Verification Process Finish</div>
        <div class="meta" id="phone-success-sub">Phone Number: 0803 123 — PIC name: Mr. Ketut</div>
      </div>
      <div class="home-cta"><button class="btn btn-primary" onclick="goHome()">Home</button></div>
    </section>

    <!-- Field List -->
    <section id="screen-field-list" class="screen">
      <div class="header"><h1>Field Verif.</h1><div class="top-meta" id="field-meta"></div></div>
      <div class="store-list card" id="fieldList"></div>
      <div class="footer-actions"><button class="btn btn-ghost" onclick="logout()">Logout</button></div>
    </section>

    <!-- Field Detail -->
    <section id="screen-field-detail" class="screen">
      <div class="header"><h1>Field Verif.</h1><div class="top-meta" id="field-detail-meta"></div></div>
      <div class="card" style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;gap:10px;align-items:center;"><div class="thumb" id="field-thumb">img</div><div><div id="field-address" class="title-big">Address: xxx</div><div class="small" id="field-pic">Old Pic — Mr. Maxi</div></div></div>
        <img id="field-hero" class="img-preview" alt="store photo" style="display:none;"/>
      </div>
      <div class="row" style="margin-top:auto;">
        <button class="btn btn-primary" id="btnFieldNext">Next</button>
        <button class="btn btn-danger" onclick="navigateBack()">Cancel</button>
      </div>
    </section>

    <!-- Field Heading -->
    <section id="screen-field-heading" class="screen">
      <div class="header"><h1>Field Verif.</h1><div class="top-meta"></div></div>
      <div class="card" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div style="font-size:48px;">📷</div>
        <div class="title-big">Heading</div>
        <div class="small">Short instruction about what to capture and how to behave in the field. Keep phone steady, take wide shot.</div>
      </div>
      <div class="row" style="margin-top:auto;">
        <button class="btn btn-primary" id="btnHeadingNext">Next</button>
        <button class="btn btn-ghost" onclick="navigateBack()">Back</button>
      </div>
    </section>

    <!-- Field Questions -->
    <section id="screen-field-questions" class="screen">
      <div class="card-scroll" style="gap:12px;">
        <div class="upload-area" id="uploadArea">
          <img id="uploadPreview" class="img-preview" src="" alt="preview" style="display:none;"/>
          <div id="uploadPlaceholder">No photo yet</div>
          <label class="btn btn-ghost" style="margin-top:8px;cursor:pointer;"><input id="photoInput" type="file" accept="image/*">UPLOAD PHOTO</label>
        </div>
        <div class="questions" id="fieldQuestions"></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-primary" id="fieldSubmit">Submit</button>
          <button class="btn btn-ghost" onclick="navigateBack()">Back</button>
        </div>
      </div>
    </section>

    <!-- Field Success -->
    <section id="screen-field-success" class="screen">
      <div class="header"><h1>Field Verif.</h1><div class="top-meta"></div></div>
      <div class="card" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="title-big">Verification Process Finish</div>
        <img id="field-success-thumb" class="img-preview" src="" style="display:none;max-width:280px;"/>
        <div class="meta" id="field-success-sub"></div>
      </div>
      <div class="home-cta"><button class="btn btn-primary" onclick="goHome()">Home</button></div>
    </section>

  </div>
</div>

<script>
/* ---------- Navigation / helpers ---------- */
const screens = Array.from(document.querySelectorAll('.screen'));
function show(id){
  screens.forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.add('active');
  window.currentScreen = id;
  Array.from(el.querySelectorAll('.card-scroll')).forEach(c=>c.scrollTop=0);
  window.scrollTo(0,0);
}
const stack = [];
function navigateTo(id, params){
  stack.push(window.currentScreen || 'screen-login');
  renderParams(params);
  show(id);
}
function navigateBack(){ const prev = stack.pop() || 'screen-login'; show(prev); }
function goHome(){ const user = localStorage.getItem('ver_user')||''; if(user.includes('phone')) startMode('phone'); else if(user.includes('field')) startMode('field'); else show('screen-select'); }
function logout(){ localStorage.removeItem('ver_user'); sessionStorage.clear(); stack.length=0; show('screen-login'); }

/* ---------- Demo / login ---------- */
const demoUsers = { phone_user: {password:'phone123', mode:'phone'}, field_user: {password:'field123', mode:'field'} };
function fillDemo(type){ if(type==='phone'){ document.getElementById('username').value='phone_user'; document.getElementById('password').value='phone123'; } else { document.getElementById('username').value='field_user'; document.getElementById('password').value='field123'; } }
function clearForm(){ document.getElementById('username').value=''; document.getElementById('password').value=''; }

document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(!u) return alert('Enter username');
  if(demoUsers[u] && demoUsers[u].password === p){ localStorage.setItem('ver_user', u); startMode(demoUsers[u].mode); return; }
  localStorage.setItem('ver_user', u);
  if(u.toLowerCase().includes('phone')) startMode('phone');
  else if(u.toLowerCase().includes('field')) startMode('field');
  else navigateTo('screen-select');
});

/* ---------- Demo store data ---------- */
const storesPhone = [
  {id:'p1',name:'XYZ Store',pic:'Mr. Ketut',phone:'0803 123'},
  {id:'p2',name:'DEF Store',pic:'Ms. Ade',phone:'0803 234'},
  {id:'p3',name:'ABC Store',pic:'Mr. Sam',phone:'0803 345'},
];
const storesField = [
  {id:'f1',name:'GHI Store',pic:'Mr. Maxi',addr:'12 Baker Street, Lagos',img:''},
  {id:'f2',name:'XAB Store',pic:'Ms. Lara',addr:'41 Central Ave',img:''},
  {id:'f3',name:'XAC Store',pic:'Mr. Sam',addr:'8 Old Road',img:''},
];

/* ---------- status helpers (persisted in localStorage) ---------- */
function getStatus(mode, id){
  return localStorage.getItem('status_'+mode+'_'+id) || 'pending';
}
function setStatus(mode, id, status){
  localStorage.setItem('status_'+mode+'_'+id, status);
}

/* ---------- store card with status badge ---------- */
function createStoreCard(item, type){
  const status = getStatus(type, item.id);
  const wrapper = document.createElement('div');
  wrapper.className='store-item';
  wrapper.dataset.id=item.id;
  wrapper.innerHTML = `
    <div class="thumb">${(item.name||'Store').split(' ')[0][0] || 'S'}</div>
    <div class="store-info">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:700">${item.name}</div>
        <div><span class="status-badge ${status==='completed' ? 'completed' : ''}">${status}</span></div>
      </div>
      <div class="meta">PIC: ${item.pic}</div>
    </div>
    <div class="chev">›</div>
  `;
  wrapper.addEventListener('click', ()=>{
    if(type==='phone') openPhoneDetail(item.id);
    else openFieldDetail(item.id);
  });
  return wrapper;
}

/* ---------- populate lists with status summary ---------- */
function populatePhoneList(){
  const list = document.getElementById('phoneList'); list.innerHTML='';
  storesPhone.forEach(s=>list.appendChild(createStoreCard(s,'phone')));
  const completed = storesPhone.filter(s=> getStatus('phone', s.id) === 'completed').length;
  document.getElementById('phone-meta').textContent = `${completed}/${storesPhone.length} completed • Tap a store to view`;
}
function populateFieldList(){
  const list = document.getElementById('fieldList'); list.innerHTML='';
  storesField.forEach(s=>list.appendChild(createStoreCard(s,'field')));
  const completed = storesField.filter(s=> getStatus('field', s.id) === 'completed').length;
  document.getElementById('field-meta').textContent = `${completed}/${storesField.length} completed • Tap a store to view`;
}

/* ---------- start mode (fixes login error) ---------- */
function startMode(mode){
  if(mode === 'phone'){
    populatePhoneList();
    show('screen-phone-list');
  } else {
    populateFieldList();
    show('screen-field-list');
  }
}

/* ---------- QUESTIONS (including new selects) ---------- */
let allQuestions = [
  {id:'q2', q:'Is the person in charge (PIC) Mr. A?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q3', q:'Is the store located at A Street?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q4', q:'Is the store located in Old Market?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q5', q:'Is the store based in Apapa, Lagos State?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q6', q:'Is the store’s contact number +234809123?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q10', q:'For So Klin, do you sell more than 1000 cartons per week?', type:'yesno', expectedOption:'No', applicableTo:['phone','field']},
  {id:'q14', q:'Do you sell only So Klin and Viva brands?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},
  {id:'q15', q:'Is your So Klin stock supplied by EMA?', type:'yesno', expectedOption:'Yes', applicableTo:['phone','field']},

  // NEW: Good Mama 50g weekly sales (3 options)
  {id:'q16',
   q:'Your weekly sales for the product Good Mama 50g is?',
   type:'select',
   options:['Less than 5 CTN','Between 5 and 10 CTN','Above 10 CTN'],
   expectedOption:'',
   applicableTo:['phone','field']
  },

  // NEW: So Klin 100g weekly sales (2 options)
  {id:'q17',
   q:'Your weekly sales for the product Supreme 100g is?',
   type:'select',
   options:['Less than 5 CTN','Above 5 CTN'],
   expectedOption:'',
   applicableTo:['phone','field']
  }
];

/* ---------- pick random questions ---------- */
function pickRandomQuestions(mode, count = 3){
  const pool = allQuestions.filter(q => !q.applicableTo || q.applicableTo.includes(mode));
  const out = [];
  const used = new Set();
  const max = Math.min(count, pool.length);
  while(out.length < max){
    const idx = Math.floor(Math.random()*pool.length);
    if(used.has(idx)) continue;
    used.add(idx);
    out.push(JSON.parse(JSON.stringify(pool[idx])));
  }
  return out;
}

/* ---------- answer storage helpers ----------
   - yes/no stored as 1/0
   - select stored as string option
   - phone answers in sessionStorage key 'answers_phone_<storeId>'
   - field answers in sessionStorage key 'answers_field_<storeId>'
*/
function setAnswer(storeId,qid,val,mode){
  const key = 'answers_'+mode+'_'+storeId;
  const data = JSON.parse(sessionStorage.getItem(key)||'{}');
  if (typeof val === 'boolean') data[qid] = (val ? 1 : 0);
  else data[qid] = val;
  sessionStorage.setItem(key, JSON.stringify(data));
}
function getAnswer(storeId,qid,mode){
  const key = 'answers_'+mode+'_'+storeId;
  const data = JSON.parse(sessionStorage.getItem(key)||'{}');
  if (!(qid in data)) return null;
  const v = data[qid];
  if (v === 1) return true;
  if (v === 0) return false;
  return v;
}
function setFieldAnswer(storeId,qid,val){
  setAnswer(storeId,qid,val,'field');
}
function getFieldAnswer(storeId,qid){
  return getAnswer(storeId,qid,'field');
}

/* ---------- phone flow ---------- */
let currentPhone = null;
let currentPhoneQs = [];
function openPhoneDetail(id){
  const item = storesPhone.find(s=>s.id===id);
  currentPhone = item;
  document.getElementById('phone-detail-title').textContent = item.name || 'Handling Obj.';
  document.getElementById('phone-detail-sub').textContent = `Phone Number: ${item.phone} — PIC name: ${item.pic}`;
  document.getElementById('phone-detail-body').textContent = 'Please verify the store information by asking the short checklist questions when you call.';
  navigateTo('screen-phone-detail');
}
document.getElementById('btnPhoneStart').addEventListener('click', ()=>{
  currentPhoneQs = pickRandomQuestions('phone', 3);
  populatePhoneQuestions();
  navigateTo('screen-phone-questions');
});

function populatePhoneQuestions(){
  const el = document.getElementById('phoneQuestions');
  el.innerHTML='';
  if(!currentPhone || !currentPhone.id) return alert('No store selected');
  currentPhoneQs.forEach(q=>{
    const div = document.createElement('div'); div.className='q';
    const left = document.createElement('div'); left.style.flex = '1';
    left.innerHTML = `<div style="font-weight:700">${q.q}</div><div class="small">question id: ${q.id}</div>`;
    div.appendChild(left);

    if(!q.type || q.type === 'yesno'){
      const yesno = document.createElement('div'); yesno.className='yesno';
      const yes = document.createElement('div'); yes.className='chip'; yes.textContent='YES';
      const no = document.createElement('div'); no.className='chip'; no.textContent='NO';
      yes.addEventListener('click', ()=>{ setAnswer(currentPhone.id,q.id,true,'phone'); yes.classList.add('active','yes'); no.classList.remove('active','no'); });
      no.addEventListener('click', ()=>{ setAnswer(currentPhone.id,q.id,false,'phone'); no.classList.add('active','no'); yes.classList.remove('active','yes'); });
      const prev = getAnswer(currentPhone.id,q.id,'phone');
      if(prev===true) yes.classList.add('active','yes');
      if(prev===false) no.classList.add('active','no');
      yesno.appendChild(yes); yesno.appendChild(no);
      div.appendChild(yesno);
    } else if (q.type === 'select'){
      const opts = document.createElement('div'); opts.className='yesno';
      q.options.forEach(opt=>{
        const c = document.createElement('div'); c.className='chip'; c.textContent = opt;
        c.addEventListener('click', ()=>{
          setAnswer(currentPhone.id,q.id,opt,'phone');
          Array.from(opts.children).forEach(ch => ch.classList.remove('active'));
          c.classList.add('active');
        });
        opts.appendChild(c);
      });
      const prev = getAnswer(currentPhone.id,q.id,'phone');
      if(prev && typeof prev === 'string'){
        Array.from(opts.children).forEach(ch=>{
          if(ch.textContent === prev) ch.classList.add('active');
        });
      }
      div.appendChild(opts);
    }

    el.appendChild(div);
  });
  const card = document.getElementById('phoneQuestionsCard');
  if(card) card.scrollTop = 0;
}

/* ---------- phone submit ---------- */
document.getElementById('phoneSubmit').addEventListener('click', ()=>{
  if(!currentPhone) return alert('No store selected');
  const key = 'answers_phone_'+currentPhone.id;
  const data = JSON.parse(sessionStorage.getItem(key)||'{}');
  const allAnswered = currentPhoneQs.every(q=> q.id in data);
  if(!allAnswered) return alert('Please answer all questions.');
  // prepare comparisons (useful for backend)
  const comparisons = currentPhoneQs.map(q => {
    const raw = data[q.id];
    let got;
    if(q.type === 'select') got = raw || 'N/A';
    else got = (raw===1) ? 'Yes' : 'No';

    const expectedOpt = (q.expectedOption||'').toString().trim();
    let match = null;
    if(expectedOpt.length){
      if(q.type === 'select'){
        match = expectedOpt.toLowerCase() === (''+raw).toLowerCase();
      } else {
        const expectedBool = expectedOpt.toLowerCase() === 'yes' ? 1 : expectedOpt.toLowerCase() === 'no' ? 0 : null;
        if(expectedBool === null) match = null; else match = (raw === expectedBool);
      }
    }
    return { qid: q.id, question: q.q, answer: got, expected: expectedOpt || 'N/A', match };
  });

  // mark completed
  setStatus('phone', currentPhone.id, 'completed');
  populatePhoneList();
  document.getElementById('phone-success-sub').textContent = `Phone Number: ${currentPhone.phone} — PIC name: ${currentPhone.pic}`;

  // optional: send `comparisons` to server here

  navigateTo('screen-phone-success');
});

/* ---------- field flow ---------- */
let currentField = null;
let currentFieldQs = [];
function openFieldDetail(id){
  const item = storesField.find(s=>s.id===id);
  currentField = item;
  document.getElementById('field-address').textContent = item.addr;
  document.getElementById('field-pic').textContent = 'Old PIC name: ' + item.pic;
  if(item.img){ document.getElementById('field-hero').src = item.img; document.getElementById('field-hero').style.display='block'; }
  else { document.getElementById('field-hero').style.display='none'; }
  navigateTo('screen-field-detail');
}
document.getElementById('btnFieldNext').addEventListener('click', ()=>{ navigateTo('screen-field-heading'); });
document.getElementById('btnHeadingNext').addEventListener('click', ()=>{
  currentFieldQs = pickRandomQuestions('field', 3);
  populateFieldQuestions();
  navigateTo('screen-field-questions');
});

function populateFieldQuestions(){
  const el = document.getElementById('fieldQuestions'); el.innerHTML='';
  if(!currentField || !currentField.id) return alert('No store selected');
  currentFieldQs.forEach(q=>{
    const div = document.createElement('div'); div.className='q';
    const left = document.createElement('div'); left.style.flex = '1';
    left.innerHTML = `<div style="font-weight:700">${q.q}</div><div class="small">question id: ${q.id}</div>`;
    div.appendChild(left);

    if(!q.type || q.type === 'yesno'){
      const yesno = document.createElement('div'); yesno.className='yesno';
      const yes = document.createElement('div'); yes.className='chip'; yes.textContent='YES';
      const no = document.createElement('div'); no.className='chip'; no.textContent='NO';
      yes.addEventListener('click', ()=>{ setFieldAnswer(currentField.id,q.id,true); yes.classList.add('active','yes'); no.classList.remove('active','no'); });
      no.addEventListener('click', ()=>{ setFieldAnswer(currentField.id,q.id,false); no.classList.add('active','no'); yes.classList.remove('active','yes'); });
      const prev = getFieldAnswer(currentField.id,q.id);
      if(prev===true) yes.classList.add('active','yes');
      if(prev===false) no.classList.add('active','no');
      yesno.appendChild(yes); yesno.appendChild(no);
      div.appendChild(yesno);
    } else if (q.type === 'select'){
      const opts = document.createElement('div'); opts.className='yesno';
      q.options.forEach(opt=>{
        const c = document.createElement('div'); c.className='chip'; c.textContent = opt;
        c.addEventListener('click', ()=>{
          setFieldAnswer(currentField.id,q.id,opt);
          Array.from(opts.children).forEach(ch => ch.classList.remove('active'));
          c.classList.add('active');
        });
        opts.appendChild(c);
      });
      const prev = getFieldAnswer(currentField.id,q.id);
      if(prev && typeof prev === 'string'){
        Array.from(opts.children).forEach(ch=>{
          if(ch.textContent === prev) ch.classList.add('active');
        });
      }
      div.appendChild(opts);
    }

    el.appendChild(div);
  });

  const stored = sessionStorage.getItem('field_photo_'+currentField.id);
  const uploadPreview = document.getElementById('uploadPreview');
  const uploadPlaceholder = document.getElementById('uploadPlaceholder');
  if(stored){ uploadPreview.src = stored; uploadPreview.style.display='block'; uploadPlaceholder.style.display='none'; }
  else { uploadPreview.style.display='none'; uploadPlaceholder.style.display='block'; uploadPreview.src=''; }

  const cs = document.querySelector('#screen-field-questions .card-scroll'); if(cs) cs.scrollTop = 0;
}

/* ---------- photo handling ---------- */
const photoInput = document.getElementById('photoInput');
const uploadPreview = document.getElementById('uploadPreview');
const uploadPlaceholder = document.getElementById('uploadPlaceholder');
photoInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const dataUrl = ev.target.result;
    uploadPreview.src = dataUrl; uploadPreview.style.display='block'; uploadPlaceholder.style.display='none';
    if(currentField && currentField.id) sessionStorage.setItem('field_photo_'+currentField.id, dataUrl);
    const cs = document.querySelector('#screen-field-questions .card-scroll');
    if(cs) cs.scrollTop = cs.scrollHeight;
  };
  reader.readAsDataURL(f);
});

/* ---------- field submit ---------- */
document.getElementById('fieldSubmit').addEventListener('click', ()=>{
  if(!currentField) return alert('No store selected');
  const photo = sessionStorage.getItem('field_photo_'+currentField.id);
  const key = 'answers_field_'+currentField.id;
  const data = JSON.parse(sessionStorage.getItem(key)||'{}');
  const allAnswered = currentFieldQs.every(q=> q.id in data);
  if(!allAnswered) return alert('Please answer all questions.');
  if(!photo) return alert('Please upload a photo.');

  const comparisons = currentFieldQs.map(q=>{
    const raw = data[q.id];
    let got;
    if(q.type === 'select') got = raw || 'N/A';
    else got = (raw===1) ? 'Yes' : 'No';

    const expectedOpt = (q.expectedOption||'').toString().trim();
    let match = null;
    if(expectedOpt.length){
      if(q.type === 'select'){
        match = expectedOpt.toLowerCase() === (''+raw).toLowerCase();
      } else {
        const expectedBool = expectedOpt.toLowerCase() === 'yes' ? 1 : expectedOpt.toLowerCase() === 'no' ? 0 : null;
        if(expectedBool === null) match = null; else match = (raw === expectedBool);
      }
    }
    return { qid: q.id, question: q.q, answer: got, expected: expectedOpt || 'N/A', match };
  });

  // persist completed status and update list
  setStatus('field', currentField.id, 'completed');
  populateFieldList();

  document.getElementById('field-success-sub').textContent = `Store: ${currentField.name} — PIC: ${currentField.pic}`;
  const sthumb = document.getElementById('field-success-thumb'); sthumb.src = photo; sthumb.style.display='block';

  // optional: send `comparisons` + photo to backend here

  navigateTo('screen-field-success');
});

/* ---------- helpers ---------- */
function renderParams(params){ /* reserved */ }

/* ---------- start ---------- */
show('screen-login');
</script>
</body>
</html>
